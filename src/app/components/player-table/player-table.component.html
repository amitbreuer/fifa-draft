<p-card class="player-table-card">
  @if (selectedPlayers.length > 0 && !showSelectedPlayers) {
  <div class="pick-controls">
    <p-button
      label="Pick Selected Players ({{selectedPlayers.length}})"
      icon="pi pi-check"
      (onClick)="pickSelectedPlayers()"
      class="p-button-success"
    ></p-button>
  </div>
  }

  <p-table
    [value]="filteredPlayers"
    [paginator]="true"
    [rows]="25"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} players"
    [rowsPerPageOptions]="[25, 50, 100]"
    dataKey="id"
    [(selection)]="selectedPlayers"
    (selectionChange)="onSelectionChange($event)"
    selectionMode="multiple"
    [metaKeySelection]="false"
    class="p-datatable-striped"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem"></th>
        <th>NAME</th>
<!--        <th>NAT</th>-->
        <th>TEAM</th>
        <th>POS</th>
        <th>OVR</th>
        <th>PAC</th>
        <th>SHO</th>
        <th>PAS</th>
        <th>DRI</th>
        <th>DEF</th>
        <th>PHY</th>
      </tr>
      <tr>
        <th>
          @if (hasActiveFilters()) {
          <p-button
            icon="pi pi-filter-slash"
            (onClick)="clearFilters()"
            [outlined]="true"
            severity="secondary"
            size="small"
            [text]="true"
          ></p-button>
          }
        </th>
        <th colspan="2">
          <p-select
            [options]="teamOptions"
            [(ngModel)]="selectedTeamId"
            (onChange)="onFilterChange()"
            placeholder="All Teams"
            [showClear]="true"
            [filter]="true"
            filterPlaceholder="Search teams"
            [style]="{'width': '100%'}"
            appendTo="body"
          ></p-select>
        </th>
        <th>
          <p-select
            [options]="positionOptions"
            [(ngModel)]="selectedPosition"
            (onChange)="onFilterChange()"
            placeholder="All Positions"
            [style]="{'width': '100%'}"
            appendTo="body"
          ></p-select>
        </th>
        <th colspan="3">
          <p-select
            [options]="nationalityOptions"
            [(ngModel)]="selectedNationalityId"
            (onChange)="onFilterChange()"
            placeholder="All Nationalities"
            [showClear]="true"
            [filter]="true"
            filterPlaceholder="Search nationalities"
            [style]="{'width': '100%'}"
            appendTo="body"
          ></p-select>
        </th>
        <th colspan="4">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <p-checkbox
              [(ngModel)]="showSelectedPlayers"
              (onChange)="onFilterChange()"
              binary="true"
              inputId="showSelected"
            ></p-checkbox>
            <label for="showSelected" style="margin: 0; cursor: pointer;">Show Selected</label>
          </div>
        </th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-player>
      @let playerName = player.commonName || `${player.firstName} ${player.lastName}`;
      @let mainStats = getMainStats(player);
      <tr (click)="onRowClick(player)" style="cursor: pointer;">
        <td (click)="$event.stopPropagation()">
          <p-tableCheckbox [value]="player"></p-tableCheckbox>
        </td>
        <td>
          <div class="player-info">
            <img
              [src]="player.shieldUrl"
              [alt]="playerName"
              class="player-shield"
              (error)="onImageError($event)"
            />
            <span class="player-name">{{ playerName }}</span>
          </div>
        </td>
<!--        <td>-->
<!--          <div class="nationality-info">-->
<!--            <img-->
<!--              [src]="player.nationality.imageUrl"-->
<!--              [alt]="player.nationality.label"-->
<!--              class="nationality-flag"-->
<!--              (error)="onImageError($event)"-->
<!--            />-->
<!--&lt;!&ndash;            <span>{{ player.nationality.label }}</span>&ndash;&gt;-->
<!--          </div>-->
<!--        </td>-->
        <td>
          <div class="team-info">
            <img
              [src]="player.team.imageUrl"
              [alt]="player.team.label"
              class="team-logo"
              (error)="onImageError($event)"
            />
            <!--            <span>{{ player.team.label }}</span>-->
          </div>
        </td>
        <td>{{ player.position.shortLabel }}</td>
        <td>
          <p-tag
            [value]="player.overallRating.toString()"
            [severity]="player.overallRating | ratingSeverity"
          ></p-tag>
        </td>
        <td>{{ mainStats.pace }}</td>
        <td>{{ mainStats.shooting }}</td>
        <td>{{ mainStats.passing }}</td>
        <td>{{ mainStats.dribbling }}</td>
        <td>{{ mainStats.defending }}</td>
        <td>{{ mainStats.physicality }}</td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Player Details Dialog -->
  <p-dialog
    [(visible)]="showPlayerDialog"
    [modal]="true"
    [closable]="true"
    [closeOnEscape]="true"
    [style]="{'width': '800px', 'max-width': '95vw'}"
    [header]="selectedPlayerForDialog ? (selectedPlayerForDialog.commonName || selectedPlayerForDialog.firstName + ' ' + selectedPlayerForDialog.lastName) : ''"
  >
    @if (selectedPlayerForDialog) {
      <div class="player-dialog-content">
        <!-- Player Stats Section - Grid Layout -->
        <div class="stats-grid">
          @let mainStats = getMainStats(selectedPlayerForDialog);
          @for (mainStat of getMainStatsKeys(); track mainStat) {
            <div class="stat-group">
              <div class="main-stat-header">
                <div class="main-stat-title">
                  <span class="main-stat-name">{{ mainStat | mainStatName }}</span>
                  <span class="main-stat-value">{{ mainStats[mainStat] }}</span>
                </div>
                <p-progressbar
                  [value]="mainStats[mainStat]"
                  [color]="mainStats[mainStat] | statSeverity"
                  [showValue]="false"
                  [class]="'main-stat-progress'"
                ></p-progressbar>
              </div>
              <div class="sub-stats">
                @for (subStat of getSubStatsForMainStat(mainStat); track subStat) {
                  @if (!subStat.startsWith('gk') || selectedPlayerForDialog.position.shortLabel === 'GK') {
                    @let statValue = selectedPlayerForDialog.stats[subStat]?.value;
                    @if (statValue !== undefined) {
                      <div class="sub-stat-item">
                        <div class="sub-stat-header">
                          <span class="sub-stat-name">{{ subStat | statName }}</span>
                          <span class="sub-stat-value">{{ statValue }}</span>
                        </div>
                        <p-progressbar
                          [value]="statValue"
                          [color]="statValue | statSeverity"
                          [showValue]="false"
                          [class]="'sub-stat-progress'"
                        ></p-progressbar>
                      </div>
                    }
                  }
                }
              </div>
            </div>
          }
        </div>

        <!-- Additional Info Section -->
        <div class="additional-info">
          <!-- Player Info Section -->
          <div class="detail-section">
            <h4>Player Info</h4>
            <div class="player-info-details">
              <div class="info-item">
                <span class="info-label">Preferred Foot:</span>
                <span class="info-value">{{ selectedPlayerForDialog.preferredFoot }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Weak Foot:</span>
                <p-rating
                  [ngModel]="selectedPlayerForDialog.weakFootAbility"
                  [readonly]="true"
                  [stars]="5"
                  class="weak-foot-rating"
                ></p-rating>
              </div>
            </div>
          </div>

          <!-- Alternative Positions Section -->
          @if (selectedPlayerForDialog.alternatePositions && selectedPlayerForDialog.alternatePositions.length > 0) {
          <div class="detail-section">
            <h4>Alternative Positions</h4>
            <div class="positions">
              @for (pos of selectedPlayerForDialog.alternatePositions; track pos.id) {
              <p-tag
                [value]="pos.shortLabel"
                severity="info"
                class="position-tag"
              ></p-tag>
              }
            </div>
          </div>
          }

          <!-- Player Abilities Section -->
          @if (selectedPlayerForDialog.playerAbilities && selectedPlayerForDialog.playerAbilities.length > 0) {
          <div class="detail-section">
            <h4>Player Abilities</h4>
            <div class="abilities">
              @for (ability of selectedPlayerForDialog.playerAbilities; track ability.id) {
              <p-tag
                [value]="ability.label"
                severity="warn"
                class="ability-tag"
              ></p-tag>
              }
            </div>
          </div>
          }
        </div>
      </div>
    }
  </p-dialog>
</p-card>
