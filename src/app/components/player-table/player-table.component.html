<p-card class="player-table-card">
  <p-table
    [value]="filteredPlayers"
    [paginator]="true"
    [rows]="50"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} players"
    [rowsPerPageOptions]="[25, 50, 100]"
    dataKey="id"
    [(selection)]="selectedPlayer"
    (selectionChange)="onSelectionChange($event)"
    selectionMode="single"
    size="small"
    class="p-datatable-striped"
    [scrollable]="true"
    scrollHeight="75vh"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem"></th>
        <th>NAME</th>
<!--        <th>NAT</th>-->
        <th>TEAM</th>
        <th>POS</th>
        <th>OVR</th>
        <th>PAC</th>
        <th>SHO</th>
        <th>PAS</th>
        <th>DRI</th>
        <th>DEF</th>
        <th>PHY</th>
      </tr>
      <tr>
        <th>
          @if (hasActiveFilters()) {
          <p-button
            icon="pi pi-filter-slash"
            (onClick)="clearFilters()"
            [outlined]="true"
            severity="secondary"
            size="small"
            [text]="true"
          ></p-button>
          }
        </th>
        <th colspan="2">
          <p-select
            [options]="teamOptions"
            [(ngModel)]="selectedTeamId"
            (onChange)="onFilterChange()"
            placeholder="All Teams"
            [showClear]="true"
            [filter]="true"
            filterPlaceholder="Search teams"
            [style]="{'width': '100%'}"
            appendTo="body"
          ></p-select>
        </th>
        <th>
          <p-multiSelect
            [options]="positionOptions"
            [(ngModel)]="selectedPositions"
            (onChange)="onFilterChange()"
            placeholder="All Positions"
            [style]="{'width': '100%'}"
            appendTo="body"
            [maxSelectedLabels]="2"
            selectedItemsLabel="{0} positions"
          ></p-multiSelect>
        </th>
        <th colspan="3">
          <p-select
            [options]="nationalityOptions"
            [(ngModel)]="selectedNationalityId"
            (onChange)="onFilterChange()"
            placeholder="All Nationalities"
            [showClear]="true"
            [filter]="true"
            filterPlaceholder="Search nationalities"
            [style]="{'width': '100%'}"
            appendTo="body"
          ></p-select>
        </th>
        <th colspan="4">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <p-checkbox
              [(ngModel)]="showSelectedPlayers"
              (onChange)="onFilterChange()"
              binary="true"
              inputId="showSelected"
            ></p-checkbox>
            <label for="showSelected" style="margin: 0; cursor: pointer;">Show Selected</label>
          </div>
        </th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-player>
      @let playerName = player.commonName || `${player.firstName} ${player.lastName}`;
      @let mainStats = getMainStats(player);
      <tr
        [class.disabled-row]="isPlayerPlacedThisTurn(player.id)"
        style="cursor: pointer;"
      >
        <td>
          <p-tableRadioButton
            [value]="player"
            [disabled]="isPlayerPlacedThisTurn(player.id)"
          ></p-tableRadioButton>
        </td>
        <td (click)="onRowClick(player, $event)">
          <div class="player-info">
            <img
              [src]="player.shieldUrl"
              [alt]="playerName"
              class="player-shield"
              (error)="onImageError($event)"
            />
            <span class="player-name">{{ playerName }}</span>
          </div>
        </td>
<!--        <td>-->
<!--          <div class="nationality-info">-->
<!--            <img-->
<!--              [src]="player.nationality.imageUrl"-->
<!--              [alt]="player.nationality.label"-->
<!--              class="nationality-flag"-->
<!--              (error)="onImageError($event)"-->
<!--            />-->
<!--&lt;!&ndash;            <span>{{ player.nationality.label }}</span>&ndash;&gt;-->
<!--          </div>-->
<!--        </td>-->
        <td>
          <div class="team-info">
            <img
              [src]="player.team.imageUrl"
              [alt]="player.team.label"
              class="team-logo"
              (error)="onImageError($event)"
            />
            <!--            <span>{{ player.team.label }}</span>-->
          </div>
        </td>
        <td>{{ player.position.shortLabel }}</td>
        <td>
          <p-tag
            [value]="player.overallRating.toString()"
            [severity]="player.overallRating | ratingSeverity"
          ></p-tag>
        </td>
        <td>{{ mainStats.pace }}</td>
        <td>{{ mainStats.shooting }}</td>
        <td>{{ mainStats.passing }}</td>
        <td>{{ mainStats.dribbling }}</td>
        <td>{{ mainStats.defending }}</td>
        <td>{{ mainStats.physicality }}</td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Player Details Dialog -->
  <p-dialog
    [(visible)]="showPlayerDialog"
    [modal]="true"
    [closable]="true"
    [closeOnEscape]="true"
    [style]="{'width': '800px', 'max-width': '95vw', 'max-height': '93vh'}"
  >
    @let playerName = selectedPlayerForDialog ? (selectedPlayerForDialog.commonName || `${selectedPlayerForDialog.firstName} ${selectedPlayerForDialog.lastName}`) : '';
    <ng-template pTemplate="header">
      <div style="display: flex; gap: 1rem; align-items: center;">
        <h2 style="margin: 0">{{playerName}}</h2>
        <button
          pButton
          type="button"
          icon="pi pi-users"
          severity="info"
          (click)="openComparisonDialog()"
          class="p-dialog-header-icon p-link"
          pTooltip="Compare"
        ></button>
      </div>
    </ng-template>
    @if (selectedPlayerForDialog) {
      <div class="player-dialog-content">
        <!-- Additional Info Section -->
        <div class="additional-info">
          <!-- Player Shield Image -->
          <div class="player-shield-section">
            <img
              [src]="selectedPlayerForDialog.shieldUrl"
              [alt]="playerName"
              class="player-shield-large"
              (error)="onImageError($event)"
            />
          </div>

          <!-- Player Info & Alternative Positions Combined -->
          <div class="detail-section">
            <h4>Player Info</h4>
            <div class="player-info-details">
              <div class="info-item">
                <span class="info-label">Preferred Foot:</span>
                <span class="info-value">{{ selectedPlayerForDialog.preferredFoot }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Weak Foot:</span>
                <p-rating
                  [ngModel]="selectedPlayerForDialog.weakFootAbility"
                  [readonly]="true"
                  [stars]="5"
                  class="weak-foot-rating"
                ></p-rating>
              </div>
            </div>

            @if (selectedPlayerForDialog.alternatePositions && selectedPlayerForDialog.alternatePositions.length > 0) {
              <div style="margin-top: 1rem;">
                <h4>Alternative Positions</h4>
                <div class="positions">
                  @for (pos of selectedPlayerForDialog.alternatePositions; track pos.id) {
                    <p-tag
                      [value]="pos.shortLabel"
                      severity="info"
                      class="position-tag"
                    ></p-tag>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Player Abilities Section -->
          @if (selectedPlayerForDialog.playerAbilities && selectedPlayerForDialog.playerAbilities.length > 0) {
            <div class="detail-section">
              <h4>Player Abilities</h4>
              <div class="abilities">
                @for (ability of selectedPlayerForDialog.playerAbilities; track ability.id) {
                  <p-tag
                    [value]="ability.label"
                    severity="warn"
                    class="ability-tag"
                  ></p-tag>
                }
              </div>
            </div>
          }
        </div>

        <!-- Player Stats Section - Grid Layout -->
        <div class="stats-grid">
          @let mainStats = getMainStats(selectedPlayerForDialog);
          @for (mainStat of getMainStatsKeys(); track mainStat) {
            <div class="stat-group">
              <div class="main-stat-header">
                <div class="main-stat-title">
                  <span class="main-stat-name">{{ mainStat | mainStatName }}</span>
                  <span class="main-stat-value">{{ mainStats[mainStat] }}</span>
                </div>
                <p-progressbar
                  [value]="mainStats[mainStat]"
                  [showValue]="false"
                  [style]="{'--progress-bar-color': mainStats[mainStat] | statSeverity}"
                  [class]="'main-stat-progress'"
                ></p-progressbar>
              </div>
              <div class="sub-stats">
                @for (subStat of getSubStatsForMainStat(mainStat); track subStat) {
                  @if (!subStat.startsWith('gk') || selectedPlayerForDialog.position.shortLabel === 'GK') {
                    @let statValue = selectedPlayerForDialog.stats[subStat]?.value;
                    @if (statValue !== undefined) {
                      <div class="sub-stat-item">
                        <div class="sub-stat-header">
                          <span class="sub-stat-name">{{ subStat | statName }}</span>
                          <span class="sub-stat-value">{{ statValue }}</span>
                        </div>
                        <p-progressbar
                          [value]="statValue"
                          [showValue]="false"
                          [style]="{'--progress-bar-color': statValue | statSeverity}"
                          [class]="'sub-stat-progress'"
                        ></p-progressbar>
                      </div>
                    }
                  }
                }
              </div>
            </div>
          }
        </div>
      </div>
    }
  </p-dialog>

  <!-- Player Comparison Dialog -->
  <p-dialog
    [(visible)]="showComparisonDialog"
    [modal]="true"
    [closable]="true"
    [closeOnEscape]="true"
    [style]="{'width': '1200px', 'max-width': '95vw'}"
  >
    @if (comparisonPlayer1) {
      <div class="comparison-dialog-content">
        <!-- Players Header -->
        <div class="comparison-header">
          <!-- Player 1 -->
          <div class="comparison-player-header">
            <div class="player-image-section">
              <img
                [src]="comparisonPlayer1.shieldUrl"
                [alt]="comparisonPlayer1.commonName || comparisonPlayer1.firstName + ' ' + comparisonPlayer1.lastName"
                class="player-shield-large"
                (error)="onImageError($event)"
              />
              <div class="player-header-info">
                <h3>{{ comparisonPlayer1.commonName || comparisonPlayer1.firstName + ' ' + comparisonPlayer1.lastName }}</h3>
                <p-tag
                  [value]="comparisonPlayer1.overallRating.toString()"
                  [severity]="comparisonPlayer1.overallRating | ratingSeverity"
                ></p-tag>
              </div>
            </div>
            <!-- Player 1 Details -->
            <div class="player-details-info">
              <div class="detail-row">
                <span class="detail-label">Position:</span>
                <div class="positions-inline">
                  <p-tag [value]="comparisonPlayer1.position.shortLabel" severity="info"></p-tag>
                  @if (comparisonPlayer1.alternatePositions && comparisonPlayer1.alternatePositions.length > 0) {
                    @for (pos of comparisonPlayer1.alternatePositions; track pos.id) {
                      <p-tag [value]="pos.shortLabel" severity="secondary"></p-tag>
                    }
                  }
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Preferred Foot:</span>
                <span class="detail-value">{{ comparisonPlayer1.preferredFoot }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Weak Foot:</span>
                <p-rating
                  [ngModel]="comparisonPlayer1.weakFootAbility"
                  [readonly]="true"
                  [stars]="5"
                  class="weak-foot-rating-inline"
                ></p-rating>
              </div>
            </div>
          </div>

          <!-- VS Divider -->
          <div class="vs-divider">VS</div>

          <!-- Player 2 Selection -->
          <div class="comparison-player-header">
            @if (comparisonPlayer2) {
              <div class="player-image-section">
                <img
                  [src]="comparisonPlayer2.shieldUrl"
                  [alt]="comparisonPlayer2.commonName || comparisonPlayer2.firstName + ' ' + comparisonPlayer2.lastName"
                  class="player-shield-large"
                  (error)="onImageError($event)"
                />
                <div class="player-header-info">
                  <h3>{{ comparisonPlayer2.commonName || comparisonPlayer2.firstName + ' ' + comparisonPlayer2.lastName }}</h3>
                  <p-tag
                    [value]="comparisonPlayer2.overallRating.toString()"
                    [severity]="comparisonPlayer2.overallRating | ratingSeverity"
                  ></p-tag>
                </div>
              </div>
              <!-- Player 2 Details -->
              <div class="player-details-info">
                <div class="detail-row">
                  <span class="detail-label">Position:</span>
                  <div class="positions-inline">
                    <p-tag [value]="comparisonPlayer2.position.shortLabel" severity="info"></p-tag>
                    @if (comparisonPlayer2.alternatePositions && comparisonPlayer2.alternatePositions.length > 0) {
                      @for (pos of comparisonPlayer2.alternatePositions; track pos.id) {
                        <p-tag [value]="pos.shortLabel" severity="secondary"></p-tag>
                      }
                    }
                  </div>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Preferred Foot:</span>
                  <span class="detail-value">{{ comparisonPlayer2.preferredFoot }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Weak Foot:</span>
                  <p-rating
                    [ngModel]="comparisonPlayer2.weakFootAbility"
                    [readonly]="true"
                    [stars]="5"
                    class="weak-foot-rating-inline"
                  ></p-rating>
                </div>
              </div>
            } @else {
              <div class="player-select-container">
                <p-select
                  [options]="playerOptions"
                  [(ngModel)]="comparisonPlayer2"
                  optionLabel="label"
                  optionValue="value"
                  [filter]="true"
                  filterBy="label"
                  placeholder="Select a player to compare"
                  [style]="{'width': '100%'}"
                  appendTo="body"
                ></p-select>
              </div>
            }
          </div>
        </div>

        <!-- Stats Comparison -->
        @if (comparisonPlayer2) {
          <div class="comparison-stats">
            @let mainStats1 = getMainStats(comparisonPlayer1);
            @let mainStats2 = getMainStats(comparisonPlayer2);
            @for (mainStat of getMainStatsKeys(); track mainStat) {
              <div class="comparison-stat-group">
                <div class="comparison-main-stat">
                  <!-- Player 1 Main Stat -->
                  <div class="player-stat-side player-stat-right">
                    <div class="main-stat-header">
                      <div class="main-stat-title">
                        <span class="main-stat-value">{{ mainStats1[mainStat] }}</span>
                      </div>
                      <p-progressbar
                        [value]="mainStats1[mainStat]"
                        [showValue]="false"
                        [style]="{'--progress-bar-color': mainStats1[mainStat] | statSeverity}"
                        [class]="'main-stat-progress'"
                      ></p-progressbar>
                    </div>
                  </div>

                  <!-- Stat Name in Middle -->
                  <div class="stat-name-middle">
                    <span class="main-stat-name">{{ mainStat | mainStatName }}</span>
                  </div>

                  <!-- Player 2 Main Stat -->
                  <div class="player-stat-side">
                    <div class="main-stat-header">
                      <div class="main-stat-title">
                        <span class="main-stat-value">{{ mainStats2[mainStat] }}</span>
                      </div>
                      <p-progressbar
                        [value]="mainStats2[mainStat]"
                        [showValue]="false"
                        [style]="{'--progress-bar-color': mainStats2[mainStat] | statSeverity}"
                        [class]="'main-stat-progress'"
                      ></p-progressbar>
                    </div>
                  </div>
                </div>

                <!-- Sub Stats -->
                <div class="comparison-sub-stats">
                  @for (subStat of getSubStatsForMainStat(mainStat); track subStat) {
                    @if (!subStat.startsWith('gk') || comparisonPlayer1.position.shortLabel === 'GK' || comparisonPlayer2.position.shortLabel === 'GK') {
                      @let statValue1 = comparisonPlayer1.stats[subStat]?.value;
                      @let statValue2 = comparisonPlayer2.stats[subStat]?.value;
                      @if (statValue1 !== undefined && statValue2 !== undefined) {
                        <div class="comparison-sub-stat">
                          <!-- Player 1 Sub Stat -->
                          <div class="player-stat-side player-stat-right">
                            <div class="sub-stat-item">
                              <div class="sub-stat-header">
                                <span class="sub-stat-value">{{ statValue1 }}</span>
                              </div>
                              <p-progressbar
                                [value]="statValue1"
                                [showValue]="false"
                                [style]="{'--progress-bar-color': statValue1 | statSeverity}"
                                [class]="'sub-stat-progress'"
                              ></p-progressbar>
                            </div>
                          </div>

                          <!-- Stat Name in Middle -->
                          <div class="stat-name-middle">
                            <span class="sub-stat-name">{{ subStat | statName }}</span>
                          </div>

                          <!-- Player 2 Sub Stat -->
                          <div class="player-stat-side">
                            <div class="sub-stat-item">
                              <div class="sub-stat-header">
                                <span class="sub-stat-value">{{ statValue2 }}</span>
                              </div>
                              <p-progressbar
                                [value]="statValue2"
                                [showValue]="false"
                                [style]="{'--progress-bar-color': statValue2 | statSeverity}"
                                [class]="'sub-stat-progress'"
                              ></p-progressbar>
                            </div>
                          </div>
                        </div>
                      }
                    }
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </p-dialog>
</p-card>
